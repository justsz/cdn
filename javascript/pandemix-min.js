pandemix=(function(){var e={};e.counter=0;e.focusedPanel=0;e.scale=1;e.panels=[];e.extraUpdates={};e.selectedLeaves=[];e.selectedNodes=[];e.selectedDate=new Date(0);e.selectedPeriod=[0,0];e.globalData={};e.map={};d3.selection.prototype.size=function(){var f=0;this.each(function(){f+=1});return f};e.extraUpdates.timeSlideUpdate=function(){d3.select("body").selectAll("span.date-calendar").text(e.selectedDate.toDateString().substring(4))};e.addGlobalZoomButton=function(f){var g=d3.select(f).attr("class","zoomControl");g.append("div").attr("class","zoom increase").on("click",function(){d(1)});g.append("div").attr("class","zoom decrease").on("click",function(){d(-1)})};e.addPlayPauseButton=function(h){var g=false,l,m=100,j=10,f=d3.select(h).attr("class","playPauseButton").on("click",function(){if(g){g=false;clearInterval(l)}else{g=true;l=setInterval(function(){if(e.selectedDate){e.selectedDate.setDate(e.selectedDate.getDate()+j);if(e.selectedDate>e.maxDate){e.selectedDate=new Date(e.maxDate.getTime());clearInterval(l);g=false;f.classed("playing",g)}}else{e.selectedDate=e.minDate}e.callUpdate("timeSlideUpdate")},m)}f.classed("playing",g)})};e.addSearchBox=function(f){d3.select(f).attr("class","searchBox").append("input").attr("type","text").attr("id","searchInput").attr("value","search").on("keyup",b)};e.addColorPicker=function(f){d3.select(f).attr("class","colorBox").append("input").attr("type","text").attr("id","colorInput").attr("value","color").on("keyup",a)};function b(f){var f=f||d3.select("input#searchInput").node().value;var g=new RegExp(f);var h=[];if(f){d3.selectAll("svg.treePanel").selectAll(".leaf").each(function(j){if(g.test(j.name)){h.push(j)}})}e.selectedLeaves=h;e.callUpdate("leafSelectionUpdate")}function a(){var f=d3.select("input#colorInput").node().value;if(f===""){f=null}e.callUpdate("leafColorUpdate",f)}function d(f){var g=e.scale+0.5*f;if(g<1){g=1}e.scale=g;e.callUpdate("zoomUpdate")}e.initializeCrossfilter=function(){e.nodes=crossfilter();e.nodeDateDim=e.nodes.dimension(function(f){return f.date});e.links=crossfilter();e.linkStartDateDim=e.links.dimension(function(f){return f.startDate});e.linkEndDateDim=e.links.dimension(function(f){return f.endDate});e.treeIdDim=e.links.dimension(function(f){return f.treeID});e.taxa=crossfilter();e.nameDim=e.taxa.dimension(function(f){return f.name});e.locDim=e.taxa.dimension(function(f){return f.location});e.dateDim=e.taxa.dimension(function(f){return f.date})};e.getNodeKey=function(g,f){return(g.name||f)};e.getLinkKey=function(g,f){return(g.target.name||f)};e.contains=function(f,h){var g;for(g=0;g<f.length;g+=1){if(f[g]===h){return true}}return false};e.accContains=function(f,h,j,l){var g;for(g=0;g<f.length;g+=1){if(j(f[g])===l(h)){return true}}return false};e.indexOf=function(f,h,j,l){var g;for(g=0;g<f.length;g+=1){if(j(f[g])===l(h)){return g}}return -1};e.containsLeaf=function(f,h){if(f.length===0){return false}var g;for(g=0;g<f.length;g+=1){if(f[g].name===h.name){return true}}return false};e.callUpdate=function(f){var g;for(g=0;g<e.panels.length;g+=1){if(e.panels[g].hasOwnProperty(f)){e.panels[g][f](arguments)}}if(e.extraUpdates.hasOwnProperty(f)){e.extraUpdates[f]}};e.panelsLoaded=function(f){var g=true,h;for(h=0;h<e.panels.length;h+=1){if(e.panels[h].panelType===f&&e.panels[h].hasOwnProperty("finishedLoading")){g=g&&e.panels[h].finishedLoading()}}return g};e.when=function(j,h,f){var f=f||100;window.setTimeout(function g(){if(j()){h()}else{window.setTimeout(g,f)}},f)};e.getHSBColor=function(o,n,h,j,m){if(!(o&&n)&&o!==0){throw new Error("Called for HSB color without specifying color index or total colors.")}var f=h||0;var g=j||75;var p=m||50;var q=o%n;var l=(f+q*360/n)%360;return"hsl("+l+","+g+"%,"+p+"%)"};return e}());(function(){pandemix.TreePanel=function(){var O,d=undefined,J,aa,m,I=true,j,r,S,Q,T,h,X,w,V,C,A,ac,z,b,P,n,l,R,a,f,g,ad=30,p=20,F=5,H=8,M=20,G,v;function o(af,ae){var ah,ag;for(ah=0;ah<af.length;ah+=1){for(ag=0;ag<ae[0].length;ag+=1){if(af[ah]===ae[0][ag].__data__.target){af[ah].uplink=d3.select(ae[0][ag]);break}}}}function y(af){var ae=[],ag;for(ag=0;ag<af.length;ag+=1){if(af[ag].uplink){ae.push(af[ag].uplink)}}return ae}function ab(af){var ae=true,ag;while(ae){ae=false;for(ag=0;ag<af.length;ag+=1){if(af[ag].parent.children[0]===af[ag]){if(contains(af,af[ag].parent.children[1])&&!contains(af,af[ag].parent)){af.push(af[ag].parent);ae=true}}else{if(contains(af,af[ag].parent.children[0])&&!contains(af,af[ag].parent)){af.push(af[ag].parent);ae=true}}}}}function x(ah){var af;var ae=ah.slice(0);var ai=Infinity;ae.forEach(function(aj){if(aj.depth<ai){ai=aj.depth}});for(af=0;af<ae.length;af+=1){while(ae[af].depth>ai){ae[af]=ae[af].parent}}var ag=false;while(!ag){ag=true;for(af=1;af<ae.length;af+=1){if(ae[af]!==ae[0]){for(af=0;af<ae.length;af+=1){ae[af]=ae[af].parent}ag=false;break}}}return ae[0]}pandemix.nodeHeightToDate=function(af,ae){return new Date((ae-1970-af)*31557600000)};pandemix.dateToNodeHeight=function(af,ae){return ae-1970-af/31557600000};function K(ae){P.attr("x1",ae).attr("y1",S(v)).attr("x2",ae).attr("y2",0)}function W(ae){return"M"+r(ae.source.height)+","+S(ae.source.x)+"V"+S(ae.target.x)+"H"+r(ae.target.height)}function B(ae){return"M"+0+","+0+"h"+(r(ae.height)-r(C))}function t(af,ag){var ae;for(ae=0;ae<ag.length;ae+=1){if(ag[ae].name===af.name){ag.splice(ae,1);return}}console.log("removable element not found")}function E(ag,af){var ae=function(aj,al){var ak;al(aj);if(aj.children){for(ak=0;ak<aj.children.length;ak+=1){ae(aj.children[ak],al)}}};ae(ag[0],function(al){al.rootDist=(al.parent?al.parent.rootDist:0)+(al.length);var aj=al.height;var ak=al.parent?al.parent.height:0;var am=aj-ak;if(am>0){console.log(O+" "+am)}});console.log(O+" height span "+(V-C));var ai=ag.map(function(aj){return aj.rootDist});console.log(O+" length span "+d3.max(ai));var ah=d3.scale.linear().domain([0,d3.max(ai)]).range([0,af]);return ah}function U(){return navigator.appVersion.indexOf("Mac")!=-1}function q(){if(pandemix.focusedPanel!=O){pandemix.selectedNodes=[];pandemix.callUpdate("nodeSelectionUpdate");pandemix.selectedLeaves=[];pandemix.callUpdate("leafSelectionUpdate");Z()}pandemix.focusedPanel=O;l=[d3.mouse(this),[]];d3.select(this.parentNode).append("rect").attr("id","extent").attr("x",l[0][0]).attr("y",l[0][1]).attr("width",0).attr("height",0);if(pandemix.brushHighlight){pandemix.selectedLeaves=[];pandemix.selectedPeriod=[0,0];d3.select(".axis").call(pandemix.globalTimeBrush.clear());pandemix.brushHighlight.remove();pandemix.brushHighlight=null;pandemix.callUpdate("leafSelectionUpdate");pandemix.callUpdate("timeSelectionUpdate")}d3.event.preventDefault()}function u(){if(l){l[1]=d3.mouse(A[0][0]);if(l[1][0]>r(C)){l[1][0]=r(C)}if(l[1][1]>S(f-2*p)){l[1][1]=S(f-2*p)}d3.select("#extent").attr("x",d3.min([l[0][0],l[1][0]])).attr("y",d3.min([l[0][1],l[1][1]])).attr("width",Math.abs(l[1][0]-l[0][0])).attr("height",Math.abs(l[1][1]-l[0][1]))}}function D(){if(l){var ae,af;d3.select("#extent").remove();if(l[1][0]<l[0][0]){ae=l[0][0];l[0][0]=l[1][0];l[1][0]=ae}if(l[1][1]<l[0][1]){ae=l[0][1];l[0][1]=l[1][1];l[1][1]=ae}af=[];Q.each(function(ag){if(l[1][0]>r(ag.source.height)){if(ag.target.x>ag.source.x){if(l[0][1]<S(ag.target.x)&&(l[1][1]>S(ag.target.x)&&l[0][0]<r(ag.target.height)||l[0][0]<r(ag.source.height)&&l[1][1]>S(ag.source.x))){af.push(ag.target)}}else{if(l[1][1]>S(ag.target.x)&&(l[0][1]<S(ag.target.x)&&l[0][0]<r(ag.target.height)||l[0][0]<r(ag.source.height)&&l[0][1]<S(ag.source.x))){af.push(ag.target)}}}});if(af.length>1){Z(x(af))}else{if(af.length===1){Z(af[0])}else{Z()}}l=undefined;d3.event.preventDefault()}}function Z(af){if(!af){if(!d3.event.shiftKey){pandemix.selectedNodes=[];pandemix.callUpdate("nodeSelectionUpdate");pandemix.selectedLeaves=[];pandemix.callUpdate("leafSelectionUpdate")}}else{var ah=Y(af),ag,ae;if(!d3.event.shiftKey){pandemix.selectedLeaves=ah.slice(0)}else{for(ae=0;ae<ah.length;ae+=1){if(!pandemix.containsLeaf(pandemix.selectedLeaves,ah[ae])){pandemix.selectedLeaves.push(ah[ae])}}}pandemix.callUpdate("leafSelectionUpdate");ag=y(ah).concat(y(N(af)));if(!d3.event.shiftKey){Q.classed("highlighted",false)}if(af.depth!==Infinity){for(ae=0;ae<ag.length;ae+=1){ag[ae].classed("highlighted",true)}}}}function N(ag){var ae=[];if(ag.children){ae.push(ag);for(var af=0;af<ag.children.length;af++){ae=ae.concat(N(ag.children[af]))}}return ae}function e(ag,af){ag.parent=af;if(ag.children){for(var ae=0;ae<ag.children.length;ae++){e(ag.children[ae],ag)}}}function Y(ag){var ae=[];if(ag.children){for(var af=0;af<ag.children.length;af++){ae=ae.concat(Y(ag.children[af]))}}else{ae.push(ag)}return ae}var s={panelType:"treePanel",finishedLoading:false,panelID:undefined,treeData:undefined,maxHeight:function(){return V},minHeight:function(){return C},placePanel:function(af,ae){O=0+pandemix.counter;this.panelID=O;pandemix.focusedPanel=O;var ag=d3.select(af).classed("treePanel",true);if(ag.classed("collapsible")){m=ag.append("div").attr("class","panelControl");m.append("div").attr("class","panelControl collapseButton").on("click",function(){if(I){aa.style("display","none")}else{aa.style("display",null)}I=!I})}aa=ag.append("div").attr("class","treePanel svgBox");a=parseInt(aa.style("width").replace(/\D+/,""),10);f=parseInt(aa.style("height").replace(/\D+/,""),10);j=aa.append("svg").attr("class","treeTopology").attr("width",a+"px").attr("height",f+"px");G=a-ad;v=f-2*p;pandemix.panels.push(s);pandemix.counter+=1},initializePanelData:function(af,ae){var ag=this;d=ae||(function(){var ah=0;pandemix.panels.forEach(function(ai){if(ai.panelType==="treePanel"){ah+=1}});return pandemix.getHSBColor(ah,6,Math.floor(ah/6)*10)})();d3.json(af,function(au){var al,aq,av,ak,am,ap,ao,aj,ai=/(.+)\.fullSet/;ag.treeData=au;if(m){m.append("div").attr("class","panelControl name").text(au.name)}ac=parseFloat(au.origin);J=d3.layout.cluster().size([v,G]).separation(function(){return 1});e(au.root,undefined);al=J.nodes(au.root);aq=J.links(al);ak=[];for(am=0;am<al.length;am+=1){if(!al[am].children){ak.push(al[am].height)}}C=d3.min(ak);V=au.root.height;aq.push();r=d3.scale.linear().domain([V,C]).range([0,G]);S=d3.scale.linear().domain([0,v]).range([0,v]);var ap=j.append("g").attr("transform","translate("+ad+","+p+")");P=ap.append("line").attr("class","aimLine");K(0);Q=ap.selectAll("path.link").data(aq,pandemix.getLinkKey).enter().append("path").attr("class","link").attr("d",W);o(al,Q);ap.selectAll(".node").data(al,pandemix.getNodeKey).enter().append("g").attr("class",function(aw){if(aw.children){if(aw.depth===0){return"root inner node"}return"inner node"}return"leaf node"});T=ap.selectAll(".inner");ap.select(".root").append("path").attr("class","rootLink").attr("d",function(){return"M"+0+","+0+"h"+-20});h=ap.selectAll(".leaf");var at=v/h.size();h.append("text").attr("class","leafText").attr("dx",H).attr("text-anchor","start").text(function(aw){return aw.name});var ar=0;h.each(function(){var aw=d3.select(this).select("text")[0][0].getComputedTextLength();if(aw>ar){ar=aw}});G=G-H-ar-M;r.range([0,G]);h.append("path").attr("class","dashedLink").attr("d",B);h.append("rect").attr("class","leafBack").attr("y",-at/2).attr("x",F).attr("width",ar+F).attr("height",at).on("click",function(){pandemix.focusedPanel=O;var az=d3.select(this.parentNode);Q.classed("highlighted",false);if(d3.event.metaKey||d3.event.ctrlKey){X=az;var aA=!az.classed("highlighted");az.classed("highlighted",aA);aA?pandemix.selectedLeaves.push(az.datum()):t(az.datum(),pandemix.selectedLeaves);if(aA){pandemix.callUpdate("focusUpdate",az)}}else{if(d3.event.shiftKey){var ay=X?X.datum().x:0;var ax=az.datum().x;if(ay>ax){var aw=ax;ax=ay;ay=aw}pandemix.selectedLeaves=[];h.each(function(aB){if(ay<=aB.x&&aB.x<=ax){pandemix.selectedLeaves.push(aB)}})}else{X=az;pandemix.selectedLeaves=[az.datum()];pandemix.callUpdate("focusUpdate",az)}}pandemix.callUpdate("leafSelectionUpdate")});h.each(function(aw){if(!pandemix.globalData.hasOwnProperty(aw.name)){pandemix.globalData[aw.name]={height:aw.height};pandemix.taxa.add([{name:aw.name,date:pandemix.nodeHeightToDate(aw.height,ac),location:aw.location||""}])}});for(am=0;am<pandemix.panels.length;am+=1){if(pandemix.panels[am].panelType==="legendPanel"){for(aj in au){if(au.hasOwnProperty(aj)){var an=ai.exec(aj);if(an){var ah={};ah[an[1]]=au[aj].map(function(aw){return{name:aw,color:undefined}});pandemix.panels[am].addTraits(ah)}}}pandemix.panels[am].addTraits({Tree:[{name:au.name,color:d}]})}}for(am=0;am<pandemix.panels.length;am+=1){if(pandemix.panels[am].panelType==="traitSelectionPanel"){for(aj in au){if(au.hasOwnProperty(aj)){var an=ai.exec(aj);if(an){pandemix.panels[am].addTraits([an[1]])}}}pandemix.panels[am].addTraits(["Tree"])}}A=ap.append("rect").attr("width",G).attr("height",v).attr("class","brushBox").on("mousedown",q);d3.select(document).on("mousemove.treeSelect"+O,u).on("mouseup.treeSelect"+O,D);z=d3.time.scale().domain([pandemix.nodeHeightToDate(V,ac),pandemix.nodeHeightToDate(C,ac)]).range([0,G]);z.clamp(true);ao=d3.svg.axis().scale(z).orient("bottom");b=ap.append("g").attr("class","axis").call(ao);pandemix.panels.forEach(function(aw){if(aw.panelType==="timePanel"){aw.updateGlobalTimeAxis(pandemix.nodeHeightToDate(V,ac),pandemix.nodeHeightToDate(C,ac))}});pandemix.nodes.add(al.map(function(aw){return{node:aw,date:pandemix.nodeHeightToDate(aw.height,ac),treeID:O,color:d}}));pandemix.links.add(aq.map(function(aw){return{link:aw,startDate:pandemix.nodeHeightToDate(aw.source.height,ac),endDate:pandemix.nodeHeightToDate(aw.target.height,ac),treeID:O,color:d}}));s.zoomUpdate();ag.finishedLoading=true})},leafSelectionUpdate:function(){w=h.filter(function(ae){return pandemix.containsLeaf(pandemix.selectedLeaves,ae)});h.classed("highlighted",false);w.classed("highlighted",true)},leafColorUpdate:function(ae){w.select("text").style("fill",ae[1])},timeSelectionUpdate:function(){if(n){n.attr("x",z(pandemix.selectedPeriod[0])||0).attr("width",(z(pandemix.selectedPeriod[1])-z(pandemix.selectedPeriod[0]))||0)}else{n=j.append("rect").attr("class","timeSelection").attr("x",z(pandemix.selectedPeriod[0])).attr("y",0).attr("height","100%").attr("width",z(pandemix.selectedPeriod[1])-z(pandemix.selectedPeriod[0]))}},nodeSelectionUpdate:function(){Q.classed("highlighted",false);for(var ae=0;ae<pandemix.selectedNodes.length;ae+=1){pandemix.selectedNodes[ae].uplink.classed("highlighted",true)}},traitSelectionUpdate:function(){if(pandemix.traitType&&pandemix.traitValues){Q.style("stroke",function(af){for(var ae=0;ae<pandemix.traitValues.length;ae+=1){if(af.target[pandemix.traitType]===pandemix.traitValues[ae].name){return pandemix.traitValues[ae].color}}return null})}},zoomUpdate:function(){S.range([0,v*pandemix.scale]);if(pandemix.scale===1){aa.style("overflow-y","hidden")}else{aa.style("overflow-y","auto")}j.attr("height",S(v)+2*p);b.attr("transform","translate(0,"+S(v)+")");if(pandemix.selectedDate){K(z(pandemix.selectedDate))}A.attr("height",S(v));Q.attr("d",W);T.attr("transform",function(af){return"translate("+r(af.height)+","+S(af.x)+")"});h.attr("transform",function(af){return"translate("+r(C)+","+S(af.x)+")"});var ae=S(v)/h.size();j.selectAll(".leafBack").attr("y",-ae/2).attr("height",ae)},focusUpdate:function(ae){if(O!==pandemix.focusedPanel){var af=h.filter(function(ag){return ae[1].datum().name===ag.name});if(!af.empty()){aa[0][0].scrollTop=S(af.datum().x)-f/2}}},timeSlideUpdate:function(){if(z){K(z(pandemix.selectedDate))}}};return s}})();(function(){pandemix.TraitSelectionPanel=function(){var f,o,e,g,l=0,j=0+pandemix.counter,m=["No trait"],h,d=1,b=2;pandemix.counter+=1;function n(){var p=g.selectAll(".traitRow").data(m,function(r){return r});var q=p.enter().append("g").attr("class","traitRow").on("click",function(r){g.selectAll(".traitRow").select(".traitRowBackground").classed("selected",false);d3.select(this).select(".traitRowBackground").classed("selected",true);pandemix.traitType=r;pandemix.callUpdate("traitTypeUpdate")});q.append("rect").attr("class","traitRowBackground").attr("y",-h).attr("height",h).attr("width","100%");q.select(".traitRowBackground").classed("selected",function(r){return r==="No trait"});q.append("text").attr("class","traitRowText").attr("dy",-1).text(function(r){return r});p.attr("transform",function(s,r){return"translate(0,"+((r+1)*(h+d))+")"});p.exit().remove()}var a={panelType:"traitSelectionPanel",placePanel:function(p){e=d3.select(p).classed("traitSelectionPanel",true);f=parseInt(e.style("width").replace(/\D+/,""),10);o=parseInt(e.style("height").replace(/\D+/,""),10);h=parseInt(e.style("font-size").replace(/\D+/,""),10);g=e.append("svg").attr("class","traitSvg").attr("width",f).attr("height",o);pandemix.panels.push(a)},addTraits:function(t){var r=false,q,s;for(q=0;q<t.length;q+=1){var p=false;for(s=0;s<m.length;s+=1){if(m[s]===t[q]){p=true;break}}if(!p){m.push(t[q]);r=true}}if(r){n()}}};return a}})();(function(){pandemix.LegendPanel=function(){var g,q,f,j,n=0,m=0+pandemix.counter,o={"No trait":[]},l,e=1,d=2,b=g,h=q;pandemix.counter+=1;function p(s){if(!s||!(s in o)){return}var u=function(){var x=o[s];var v=[];for(var w=0;w<x.length;w+=1){v.push({name:x[w].name,color:x[w].color||pandemix.getHSBColor(w,x.length),colorIsStatic:!!x[w].color,selected:true})}return v}();var r=j.selectAll(".traitRow").data(u,function(v){return v.name});var t=r.enter().append("g").attr("class","traitRow").on("click",function(v){if(!v.colorIsStatic){v.selected=!v.selected;pandemix.traitType=s;pandemix.traitValues=[];j.selectAll(".traitRow").each(function(w){if(w.selected){pandemix.traitValues.push(w)}});pandemix.callUpdate("traitSelectionUpdate");j.selectAll(".traitRow").select(".legendIcon").style("fill",function(w){if(w.selected){return w.color}return"gray"})}});t.append("rect").attr("class","traitRowBackground").attr("y",-l).attr("height",l).attr("width","100%").style("fill-opacity",0);t.append("rect").attr("class","legendIcon").attr("y",-l).attr("height",l).attr("width",l).style("fill",function(v){return v.color});t.append("text").attr("class","legendRowText").attr("x",(l+d)).text(function(v){return v.name});r.attr("transform",function(w,v){return"translate(0,"+((v+1)*(l+e))+")"});r.exit().remove();h=r.size()*(l+e);j.attr("height",d3.max([q,h]));if(h<q){f.style("overflow-y","hidden")}else{f.style("overflow-y",null)}r.select(".legendIcon").style("fill",function(v){if(v.selected){return v.color}return"gray"})}var a={panelType:"legendPanel",placePanel:function(r){f=d3.select(r).classed("legendPanel",true);g=parseInt(f.style("width").replace(/\D+/,""),10);q=parseInt(f.style("height").replace(/\D+/,""),10);l=parseInt(f.style("font-size").replace(/\D+/,""),10);j=f.append("svg").attr("class","legendSvg").attr("width",g).attr("height",q);pandemix.panels.push(a)},addTraits:function(v){var t=false,s;for(var r in v){if(v.hasOwnProperty(r)){if(o.hasOwnProperty(r)){for(s=0;s<v[r].length;s+=1){var u=pandemix.accContains(o[r],v[r][s],function(w){return w.name},function(w){return w.name});if(!u){o[r].push(v[r][s]);t=true}}}else{o[r]=v[r].slice(0);t=true}}}if(t){p("No trait")}},getTraits:function(){return o},traitTypeUpdate:function(){p(pandemix.traitType);pandemix.traitValues=[];j.selectAll(".traitRow").each(function(r){if(r.selected){pandemix.traitValues.push(r)}});pandemix.callUpdate("traitSelectionUpdate")}};return a}})();(function(){var n,h,g,f=[],q=[],j,o,b,d,e,p,a,m=0+pandemix.counter,l;pandemix.counter+=1;pandemix.TimePanel=function(){function y(){d3.selectAll("path.link").classed("highlighted",false)}function x(){var A=j.extent();pandemix.selectedPeriod=A;if(pandemix.brushHighlight){o.attr("x",h(A[0])).attr("width",h(A[1])-h(A[0]))}else{o=n.append("rect").attr("class","timeSelection").attr("x",h(A[0])).attr("y",0).attr("width",h(A[1])-h(A[0])).attr("height",a);pandemix.brushHighlight=o}pandemix.locDim.filter(null);pandemix.selectedLeaves=pandemix.dateDim.filterRange(A).top(Infinity);pandemix.callUpdate("timeSelectionUpdate");pandemix.callUpdate("leafSelectionUpdate")}function u(){if(j.empty()){if(o){o.remove();o=null;pandemix.brushHighlight=null}}}var v=false;var z=undefined;var r=undefined;function w(){d3.event.preventDefault();v=true;if(o){o.remove();o=null;pandemix.brushHighlight=null;pandemix.selectedPeriod=[];pandemix.selectedLeaves=[];pandemix.callUpdate("timeSelectionUpdate");pandemix.callUpdate("leafSelectionUpdate")}var A=d3.mouse(z.node())[0];if(A>p){A=p}else{if(A<0){A=0}}r.style("left",(A-e/2)+"px");pandemix.selectedDate=h.invert(A);pandemix.callUpdate("timeSlideUpdate")}function s(){d3.event.preventDefault();if(v){var A=d3.mouse(z.node())[0];if(A>p){A=p}else{if(A<0){A=0}}r.style("left",(A-e/2)+"px");pandemix.selectedDate=h.invert(A);pandemix.callUpdate("timeSlideUpdate");d3.select("body").selectAll("span.date-calendar").text(pandemix.selectedDate.toDateString().substring(4))}}function t(){if(v){v=false}}b={panelType:"timePanel",updateGlobalTimeAxis:function(A,B){f.push(A);q.push(B);pandemix.minDate=d3.min(f);pandemix.maxDate=d3.max(q);h.domain([d3.min(f),d3.max(q)]);n.call(g)},placePanel:function(A){d=d3.select(A).classed("timePanel",true);z=d.append("div").attr("class","sliderBackground").on("mousedown",w);d3.select(document).on("mousemove.time",s).on("mouseup.time",t);r=z.append("div").attr("class","timeSlider");e=parseInt(r.style("width").replace(/\D+/,""),10);r.style("left",(-e/2)+"px");n=d.append("svg").attr("class","timeLine");p=parseInt(n.style("width").replace(/\D+/,""),10);a=parseInt(n.style("height").replace(/\D+/,""),10);l=n.append("line").attr("class","aimLine").attr("x1","0").attr("x2","0").attr("y1","0").attr("y2",a);h=d3.time.scale().domain([0,1]).range([0,p]).clamp(true);g=d3.svg.axis().scale(h).orient("bottom");j=d3.svg.brush().x(h).on("brushstart",y).on("brush",x).on("brushend",u);pandemix.globalTimeBrush=j;n.call(j).call(g);pandemix.panels.push(b)},timeSlideUpdate:function(){l.attr("x1",h(pandemix.selectedDate)).attr("x2",h(pandemix.selectedDate));if(!v){var A=h(pandemix.selectedDate);if(A>p){A=p}else{if(A<0){A=0}}var B=(A-e/2);r.style("left",B+"px")}}};return b}})();(function(){pandemix.MapPanel=function(){var g,d=[[-180,-90],[180,90]],f=[],a,h=undefined,e={};contoursLoaded=false,centroidsLoaded=false,previousSelectedDate=undefined,panelID=0+pandemix.counter,zCounter=1;pandemix.counter+=1;var b={panelType:"mapPanel",placePanel:function(l,m,o){var j=m||[0,0];var n=o||4;g=new L.Map(l,{center:j,zoom:n,maxBounds:[[-90,-180],[90,180]]});a=L.control.layers(null,null).addTo(g);pandemix.panels.push(b);return b},loadContours:function(j){var l=this;d3.json(j,function(m){var n=d3.geo.path().projection(l.project);h=m;contoursLoaded=true});return b},loadCentroids:function(j){var l=this;if(!j){pandemix.when(function(){return contoursLoaded},function(){var o=d3.geo.path().projection(l.project);for(var m=0;m<h.features.length;m++){var n=o.centroid(h.features[m]);if(n){n=g.layerPointToLatLng(new L.Point(n[0],n[1]));e[h.features[m].properties.name]=[n.lng,n.lat]}}centroidsLoaded=true},100)}else{d3.csv(j,function(m){m.forEach(function(n){e[n.location]=[n.longitude,n.latitude]});centroidsLoaded=true})}return b},addTileLayer:function(m){var j=new L.TileLayer(m,{noWrap:true,zIndex:zCounter});zCounter+=1;g.addLayer(j);a.addOverlay(j,"Tiles");return b},addLayer:function(n,m){var o=this;var m=m||{};m.zIndex=zCounter;zCounter+=1;var j=new n();a.addOverlay(j,m.name||"layer");pandemix.when(function(){if(j.needsContours){return contoursLoaded}else{if(j.needsCentroids){return centroidsLoaded}else{if(j.needsContours&&j.needsCentroids){return contoursLoaded&&centroidsLoaded}else{return true}}}},function(){m.map=g;m.project=o.project;m.bounds=d;m.mapData=h;m.centroids=e;j.initDraw(m);g.addLayer(j);f.push(j)},100);return b},getMap:function(){return g},leafSelectionUpdate:function(){var l=[],j;for(j=0;j<pandemix.selectedLeaves.length;j+=1){if(!pandemix.contains(l,pandemix.selectedLeaves[j].location)){l.push(pandemix.selectedLeaves[j].location)}}for(j=0;j<f.length;j+=1){if("leafSelectionUpdate" in f[j]){f[j].leafSelectionUpdate(l)}}},timeSelectionUpdate:function(){},timeSlideUpdate:function(){var j=pandemix.selectedDate;var n=undefined;var l=undefined;if(!previousSelectedDate){l=true}else{l=previousSelectedDate<j}previousSelectedDate=j;for(i=0;i<f.length;i+=1){if("timeSlideUpdate" in f[i]){if(!n){pandemix.linkStartDateDim.filter(function(o){return o<j});var m=pandemix.linkEndDateDim.filter(function(o){return o>=j}).top(Infinity)}f[i].timeSlideUpdate(m,l)}}},traitSelectionUpdate:function(){for(var j=0;j<f.length;j+=1){if("traitSelectionUpdate" in f[j]){f[j].traitSelectionUpdate()}}},project:function(l){var j=g.latLngToLayerPoint([l[1],l[0]]);return[j.x,j.y]}};return b}})();(function(){pandemix.map.regionOutlineLayer=L.Class.extend({needsContours:true,svg:undefined,g:undefined,bounds:undefined,path:undefined,feature:undefined,project:undefined,initialize:function(){},initDraw:function(a){var b=this;b.map=a.map;b.project=a.project;b.bounds=a.bounds;b.el=L.DomUtil.create("div","provinceLayer leaflet-zoom-hide");d3.select(b.el).style("position","absolute").style("z-index",a.zIndex);b.svg=d3.select(b.el).append("svg");b.svg.on("mousedown",function(){d3.event.preventDefault()});b.g=b.svg.append("g");d(a.mapData);function d(e){b.path=d3.geo.path().projection(b.project);b.feature=b.g.selectAll(".mapPath").data(e.features).enter().append("path").attr("class","mapPath").on("click",function(f){pandemix.dateDim.filter(null);pandemix.selectedLeaves=pandemix.locDim.filter(f.properties.name).top(Infinity);pandemix.callUpdate("leafSelectionUpdate");d3.select(this).classed("mapHighlighted",true)})}b.map.getPanes().overlayPane.appendChild(b.el);b.svg.style("display","none")},onAdd:function(){var a=this;a.svg.style("display",null);a.map.on("viewreset",a.reset,a);a.reset()},onRemove:function(){var a=this;a.svg.style("display","none");a.map.off("viewreset",a.reset,a)},reset:function(){var d=this;var a=d.project(d.bounds[0]),b=d.project(d.bounds[1]);d.svg.attr("width",Math.abs(b[0]-a[0])).attr("height",Math.abs(a[1]-b[1])).style("margin-left",a[0]+"px").style("margin-top",b[1]+"px");d.g.attr("transform","translate("+-a[0]+","+-b[1]+")");d.feature.attr("d",d.path)},leafSelectionUpdate:function(a){this.feature.classed("mapHighlighted",function(b){return pandemix.contains(a,b.properties.name)})}})})();(function(){pandemix.map.centroidLayer=L.Class.extend({needsCentroids:true,svg:undefined,g:undefined,bounds:undefined,circles:undefined,project:undefined,centroids:undefined,initialize:function(){},initDraw:function(a){var b=this;b.map=a.map;b.project=a.project;b.bounds=a.bounds;b.centroids=a.centroids;b.el=L.DomUtil.create("div","centroidLayer leaflet-zoom-hide");d3.select(b.el).style("position","absolute").style("z-index",a.zIndex);b.svg=d3.select(b.el).append("svg");b.svg.on("mousedown",function(){d3.event.preventDefault()});b.g=b.svg.append("g");var d=[];for(c in b.centroids){if(b.centroids.hasOwnProperty(c)){d.push({name:c,center:[b.centroids[c][0],b.centroids[c][1]]})}}b.circles=b.g.selectAll("circle").data(d).enter().append("circle");b.map.getPanes().overlayPane.appendChild(b.el);b.svg.style("display","none")},onAdd:function(b){var a=this;a.svg.style("display",null);b.on("viewreset",a.reset,a);a.reset()},onRemove:function(b){var a=this;a.svg.style("display","none");b.off("viewreset",a.reset,a)},reset:function(){var e=this;var b=e.project(e.bounds[0]),d=e.project(e.bounds[1]);e.svg.attr("width",Math.abs(d[0]-b[0])).attr("height",Math.abs(b[1]-d[1])).style("margin-left",b[0]+"px").style("margin-top",d[1]+"px");var a=1*e.map.getZoom();e.g.attr("transform","translate("+-b[0]+","+-d[1]+")");e.circles.attr("cx",function(f){return e.project(f.center)[0]}).attr("cy",function(f){return e.project(f.center)[1]}).attr("r",a)},traitSelectionUpdate:function(){var a=this;if(pandemix.traitValues){a.circles.style("fill",function(e){for(var b=0;b<pandemix.traitValues.length;b+=1){if(e.name===pandemix.traitValues[b].name){return pandemix.traitValues[b].color}}return null})}}})})();(function(){var d=true;var b=true;var a=function(l){var e,h=true,f,g;if(l.nodes.length<1){if(l.tree.children){h=false}for(e=0;e<l.foci.length;e+=1){if(l.foci[e].name===l.tree.location){f=l.project(l.centroids[l.tree.location]);l.nodes.push({virNum:l.virNum,id:e,x:f[0],y:f[1],r:l.radius,children:l.tree.children});l.virNum+=1;break}}}else{h=true;g=[];l.nodes.forEach(function(m){if(m.children){h=false;m.children.forEach(function(n){for(e=0;e<l.foci.length;e+=1){if(l.foci[e].name===n.location){g.push({virNum:l.virNum,id:e,x:m.x,y:m.y,r:l.radius,children:n.children});l.virNum+=1;break}}})}});l.nodes=g;l.force.nodes(g)}console.log(l.nodes.length);l.force.start();var j=l.g.selectAll("circle.virusParticle").data(l.nodes,function(m){return m.virNum});j.exit().transition().attr("r",0).remove();j.enter().append("svg:circle").attr("class","virusParticle").attr("cx",function(m){return m.x}).attr("cy",function(m){return m.y}).style("fill",l.fill(l.color)).style("stroke",1).attr("r",0).transition().attr("r",function(m){return m.r});if(h){clearInterval(l.intervalID)}};pandemix.map.virusParticleLayer=L.Class.extend({needsCentroids:true,svg:undefined,g:undefined,bounds:undefined,tree:undefined,force:undefined,nodes:undefined,foci:undefined,centroids:undefined,currNodes:undefined,project:undefined,fill:d3.scale.category10(),color:undefined,radius:undefined,virNum:0,intervalID:undefined,initialize:function(){},initDraw:function(g){var h=this;h.map=g.map;h.tree=g.tree;h.project=g.project;h.centroids=g.centroids;h.currNodes=[h.tree];h.color=g.color;h.foci=[];h.bounds=g.bounds;h.el=L.DomUtil.create("div","virusParticleLayer leaflet-zoom-hide");d3.select(h.el).style("position","absolute").style("z-index",g.zIndex);h.svg=d3.select(h.el).append("svg");h.svg.on("mousedown",function(){d3.event.preventDefault()});h.g=h.svg.append("g");var e=h.reset();h.nodes=[];h.force=d3.layout.force().nodes(h.nodes).links([]).gravity(0).size(e).charge(-0.5).friction(0.85);h.force.on("tick",function(o){var n=0.1*o.alpha;h.nodes.forEach(function(q,p){q.y+=(h.foci[q.id].y-q.y)*n;q.x+=(h.foci[q.id].x-q.x)*n});h.g.selectAll("circle.virusParticle").attr("cx",function(p){return p.x}).attr("cy",function(p){return p.y})});var f=(31557600000/365.25);var l=[new Date(30*31557600000),new Date(30*31557600000+f*10)];var m;var j=[];h.map.getPanes().overlayPane.appendChild(h.el);h.svg.style("display","none")},timeSelectionUpdate:function(l){var j=this;var m=[];l.forEach(function(n){if(n.treeID===j.color){m.push(n.node)}});var e,f,g;g=[];m.forEach(function(r){var p=r.parent;var q=false;var o=[];for(e=0;e<j.nodes.length;e+=1){var s=j.nodes[e];if(s.node===p){q=true;o.push(s.x);o.push(s.y);if(d){j.nodes.splice(e,1)}break}}if(r.children){r.children.forEach(function(n){for(e=0;e<j.foci.length;e+=1){if(j.foci[e].name===n.location){if(!q){o=j.project(j.centroids[n.location])}j.nodes.push({virNum:j.virNum,id:e,x:o[0],y:o[1],r:j.radius,node:n});j.virNum+=1;break}}})}else{if(b){for(e=0;e<j.nodes.length;e+=1){var s=j.nodes[e];if(s.node===r){j.nodes.splice(e,1);break}}}}});j.force.start();var h=j.g.selectAll("circle.virusParticle").data(j.nodes,function(n){return n.virNum});h.exit().remove();h.enter().append("svg:circle").attr("class","virusParticle").attr("cx",function(n){return n.x}).attr("cy",function(n){return n.y}).style("fill",j.fill(j.color)).style("stroke",1).attr("r",function(n){return n.r})},timeSlideUpdate:function(m,g){var j=this;var l=undefined;var n=[];var e;m.forEach(function(o){if(o.treeID===j.color){n.push(o.link);l=o.color}});var f=[];n.forEach(function(o){var q=false;var p=undefined;var r=undefined;for(e=0;e<j.nodes.length;e+=1){if(j.nodes[e].node===o.target){q=true;f.push(j.nodes[e]);break}if(g&&j.nodes[e].node===o.source){p=[j.nodes[e].x,j.nodes[e].y];r=e}}if(!q){for(e=0;e<j.foci.length;e+=1){if(j.foci[e].name===o.target.location){if(g&&!p){p=j.project(j.centroids[o.source.location])}else{if(!g){p=j.project(j.centroids[o.target.location])}}f.push({virNum:j.virNum,id:e,x:p[0],y:p[1],r:j.radius,node:o.target,color:l});j.virNum+=1;break}}}});j.nodes=f;j.force.nodes(f);j.force.start();var h=j.g.selectAll("circle.virusParticle").data(j.nodes,function(o){return o.virNum});h.exit().remove();h.enter().append("svg:circle").attr("class","virusParticle").attr("cx",function(o){return o.x}).attr("cy",function(o){return o.y}).style("fill",function(o){return o.color}).style("stroke",1).attr("r",function(o){return o.r})},onAdd:function(f){var e=this;e.svg.style("display",null);f.on("viewreset",e.reset,e);e.reset()},onRemove:function(f){var e=this;e.svg.style("display","none");f.off("viewreset",e.reset,e)},reset:function(){var l=this,e,j;var f=l.project(l.bounds[0]),g=l.project(l.bounds[1]);e=g[0]-f[0];j=f[1]-g[1];l.svg.attr("width",e).attr("height",j).style("margin-left",f[0]+"px").style("margin-top",g[1]+"px");l.g.attr("transform","translate("+-f[0]+","+-g[1]+")");l.radius=l.map.getZoom();l.g.selectAll("circle.virusParticle").attr("r",l.radius);l.foci=[];for(c in l.centroids){if(l.centroids.hasOwnProperty(c)){l.foci.push({name:c,x:l.project(l.centroids[c])[0],y:l.project(l.centroids[c])[1],occupants:[],size:0})}}if(l.force){l.force.charge(-l.radius/8).start()}return[e,j]}})})();(function(){pandemix.map.bubbleChartLayer=L.Class.extend({needsCentroids:true,svg:undefined,g:undefined,bounds:undefined,tree:undefined,force:undefined,nodes:undefined,foci:undefined,centroids:undefined,project:undefined,color:undefined,sizeModifier:undefined,virNum:0,intervalID:undefined,initialize:function(){},initDraw:function(a){var b=this;b.map=a.map;b.tree=a.tree;b.project=a.project;b.centroids=a.centroids;b.color=a.color;b.foci=[];b.bounds=a.bounds;b.prevData={};b.el=L.DomUtil.create("div","bubbleChartLayer leaflet-zoom-hide");d3.select(b.el).style("position","absolute").style("z-index",a.zIndex);b.svg=d3.select(b.el).append("svg");b.svg.on("mousedown",function(){d3.event.preventDefault()});b.g=b.svg.append("g");b.nodes=[];b.force=d3.layout.force().nodes(b.nodes).links([]).gravity(0).charge(function(e){return -1*Math.floor(Math.sqrt(e.size*b.sizeModifier))});b.force.on("tick",function(f){var d=0.1*f.alpha;b.nodes.forEach(function(g,e){g.y+=(b.foci[g.id].y-g.y)*d;g.x+=(b.foci[g.id].x-g.x)*d});b.g.selectAll("circle.bubble").attr("cx",function(e){return e.x}).attr("cy",function(e){return e.y})});b.map.getPanes().overlayPane.appendChild(b.el);b.svg.style("display","none")},timeSlideUpdate:function(h){var f=this;var b;var d=[];var g={};h.forEach(function(n){var a=n.link;var m=[a.target.location,n.treeID];if(g.hasOwnProperty(m)){g[m].size+=1}else{for(b=0;b<f.foci.length;b+=1){if(f.foci[b].name===a.target.location){var j=[];var o=0;if(f.prevData.hasOwnProperty(m)){j[0]=f.prevData[m].x;j[1]=f.prevData[m].y;o=f.prevData[m].size}else{j=f.project(f.centroids[a.target.location])}g[m]={key:m,id:b,x:j[0],y:j[1],size:1,prevSize:o,color:n.color};break}}}});f.prevData=g;for(k in g){if(g.hasOwnProperty(k)){d.push(g[k])}}f.nodes=d;f.force.nodes(d);f.force.start();var e=f.g.selectAll("circle.bubble").data(f.nodes,function(a){return a.key});e.exit().transition().attr("r",0).remove();e.enter().append("svg:circle").attr("class","bubble").attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y}).style("fill",function(a){return a.color}).attr("r",0);e.transition().delay(function(a){return a.prevSize>a.size?0:250}).attr("r",function(a){return Math.sqrt(f.sizeModifier*a.size)})},onAdd:function(b){var a=this;a.svg.style("display",null);b.on("viewreset",a.reset,a);a.reset()},onRemove:function(b){var a=this;a.svg.style("display","none");b.off("viewreset",a.reset,a)},reset:function(){var g=this,b,f;if(g.force){g.force.stop()}var d=g.project(g.bounds[0]),e=g.project(g.bounds[1]);b=e[0]-d[0];f=d[1]-e[1];g.svg.attr("width",b).attr("height",f).style("margin-left",d[0]+"px").style("margin-top",e[1]+"px");g.g.attr("transform","translate("+-d[0]+","+-e[1]+")");var j=g.foci.slice(0);g.foci=[];for(c in g.centroids){if(g.centroids.hasOwnProperty(c)){g.foci.push({name:c,x:g.project(g.centroids[c])[0],y:g.project(g.centroids[c])[1]})}}if(g.nodes){g.nodes.forEach(function(h){h.x+=g.foci[h.id].x-j[h.id].x;h.y+=g.foci[h.id].y-j[h.id].y})}g.sizeModifier=g.map.getZoom()*g.map.getZoom();var a=g.g.selectAll("circle.bubble").attr("cx",function(h){return h.x}).attr("cy",function(h){return h.y}).attr("r",function(h){return Math.sqrt(g.sizeModifier*h.size)});if(pandemix.selectedDate){pandemix.callUpdate("timeSlideUpdate")}return[b,f]}})})();(function(){pandemix.map.bubbleTransLayer=L.Class.extend({needsCentroids:true,svg:undefined,g:undefined,bounds:undefined,tree:undefined,force:undefined,nodes:undefined,foci:undefined,centroids:undefined,currNodes:undefined,project:undefined,color:undefined,radius:undefined,virNum:0,intervalID:undefined,initialize:function(){},initDraw:function(a){var b=this;b.map=a.map;b.tree=a.tree;b.project=a.project;b.centroids=a.centroids;b.currNodes=[b.tree];b.color=a.color;b.foci=[];b.bounds=a.bounds;b.el=L.DomUtil.create("div","bubbleTransLayer leaflet-zoom-hide");d3.select(b.el).style("position","absolute").style("z-index",a.zIndex);b.svg=d3.select(b.el).append("svg");b.svg.on("mousedown",function(){d3.event.preventDefault()});b.g=b.svg.append("g");b.nodes=[];b.map.getPanes().overlayPane.appendChild(b.el);b.svg.style("display","none")},timeSlideUpdate:function(h,e){var g=this;var b;var d=[];var j=[];h.forEach(function(o){var a=o.link;j.push(a.target);var n=false;for(b=0;b<g.nodes.length;b+=1){if(g.nodes[b]===a.target){n=true;break}}if(!n){var m,p;if(e){if(a.source.location!==a.target.location){p=g.project(g.centroids[a.target.location]);m=g.project(g.centroids[a.source.location]);d.push({targX:p[0],targY:p[1],initX:m[0],initY:m[1],r:g.radius,treeID:o.treeID,color:o.color})}}else{if(a.target.children){a.target.children.forEach(function(l){if(l.location!==a.target.location){m=g.project(g.centroids[l.location]);p=g.project(g.centroids[a.target.location]);d.push({targX:p[0],targY:p[1],initX:m[0],initY:m[1],r:g.radius,treeID:o.treeID,color:o.color})}})}}}});g.nodes=j;var f=g.g.selectAll("circle.bubbleTrans").data(d);f.enter().append("svg:circle").attr("class","bubbleTrans").attr("cx",function(a){return a.initX}).attr("cy",function(a){return a.initY}).style("fill",function(a){return a.color}).attr("r",function(a){return a.r}).transition().ease("linear").duration(500).attr("cx",function(a){return a.targX}).attr("cy",function(a){return a.targY}).remove()},onAdd:function(b){var a=this;a.svg.style("display",null);b.on("viewreset",a.reset,a);a.reset()},onRemove:function(b){var a=this;a.svg.style("display","none");b.off("viewreset",a.reset,a)},reset:function(){var f=this,a,e;var b=f.project(f.bounds[0]),d=f.project(f.bounds[1]);a=d[0]-b[0];e=b[1]-d[1];f.svg.attr("width",a).attr("height",e).style("margin-left",b[0]+"px").style("margin-top",d[1]+"px");f.g.attr("transform","translate("+-b[0]+","+-d[1]+")");f.radius=f.map.getZoom()-1;f.g.selectAll("circle.bubbleTrans").attr("r",f.radius);f.foci=[];for(c in f.centroids){if(f.centroids.hasOwnProperty(c)){f.foci.push({name:c,x:f.project(f.centroids[c])[0],y:f.project(f.centroids[c])[1],occupants:[],size:0})}}if(f.force){f.force.charge(-f.radius/8).start()}return[a,e]}})})();