<!DOCTYPE html>
<!-- basic drawing capability taken from url=(0040)http://bl.ocks.org/mbostock/raw/2429963/ -->
<!-- some tree stuff inspired by https://gist.github.com/kueda/1036776 -->
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8">
		<title>pandemix</title>
        <!-- <link rel="stylesheet" href="css/bootstrap-responsive.css"> -->
		<link rel="stylesheet" type="text/css" href="css/treeStyles.css">
        <link rel="stylesheet" type="text/css" href="css/mapStyles.css">
        <link rel="stylesheet" type="text/css" href="css/leaflet.css" />
        <!-- <link rel="stylesheet" media="screen" href="css/bootstrap.css"> -->
        <!-- <meta name="viewport" content="width=device-width, initial-scale=1.0"> -->
		<!-- <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script> -->
        <script src="javascript/jquery-2.0.2.js"></script>
        <script src="javascript/bootstrap.js"></script>
		<script src="javascript/d3.v3.min.js"></script>
        <script src="javascript/crossfilter.min.js"></script>
        <script src="javascript/leaflet.js"></script>
		<script src="javascript/pandemix.js"></script>

    	<script src="javascript/circlePanel.js"></script>
        <script src="javascript/mapPanel.js"></script>
    	<script src="javascript/treePanel.js"></script>
    	<script src="javascript/tablePanel.js"></script>
        <script src="javascript/traitPanel.js"></script>
        <script src="javascript/legendPanel.js"></script>

        <script src="javascript/regionOutlineMapLayer.js"></script>        
        <script src="javascript/centroidMapLayer.js"></script> 
        <script src="javascript/virusParticleMapLayer.js"></script> 

	</head>
<body>

<div id="map"></div>


<script>
    //script wrapped in a function to avoid polluting namespace
    (function() {



        var i,
            contourFile = "data/reducedGeography.json",
            tileSource = "http://{s}.tile.cloudmade.com/1a1b06b230af4efdbb989ea99e9841af/998/256/{z}/{x}/{y}.png",
//            inputFiles = ["data/tree1.json", "data/tree2.json"];
            //inputFiles = ["data/MERS-CoV.json"];
              inputFiles = ["data/H9N2 Trees/H9N2.PA.json",
                              "data/H9N2 Trees/H9N2.MP.json",
                            "data/H9N2 Trees/H9N2.NS.json",
                          "data/H9N2 Trees/H9N2.PB2.json",
                          "data/H9N2 Trees/H9N2.NP.json",
                          "data/H9N2 Trees/H9N2.PB1.json"];

        var mapPanel = new pandemix.MapPanel;
        mapPanel.placePanel("map")
                .loadContours(contourFile)
                .addTileLayer(tileSource)
                .addLayer(pandemix.map.regionOutlineLayer, {name: "Regions"})
                .addLayer(pandemix.map.centroidLayer, {name: "Centroids"});

        //mapPanel.initializePanelData();
        pandemix.panels.push(mapPanel);                          

        pandemix.addSearchBox();
        pandemix.addColorPicker();
        //pandemix.addTraitBox();
        pandemix.addGlobalZoomButton();

        var traitPanel = new pandemix.TraitPanel;
        traitPanel.placePanel();
        pandemix.panels.push(traitPanel);
        

        /*var legendPanel = new pandemix.LegendPanel;
        legendPanel.placePanel();
        pandemix.panels.push(legendPanel);*/

        pandemix.addGlobalTimeAxis();
        
        var tablePanel = new pandemix.TablePanel;
        tablePanel.placePanel();
        pandemix.panels.push(tablePanel);
        
        pandemix.initializeCrossfilter();

        var row = d3.select("body").append("div").attr("class", "treePanels");
        //read each input file and draw the tree in its own div
        for (i = 0; i < inputFiles.length; i += 1) {
            // if (i % 2 === 0) {
            //     row = d3.select("body").append("div").attr("class", "row");
            // }
            var f = inputFiles[i];
            //var treePanel;

            //>>>>>>all of this extra logic doesn't work because the json isn't loaded here...
            if (f.trees) { //there are many trees in file
                // for (var e = 0; e < f.trees.length; e += 1) {
                //     console.log("ch 1");
                //     treePanel = new pandemix.TreePanel;
                //     treePanel.placePanel(row);
                //     treePanel.initializePanelData(f.trees[e]);
                //     pandemix.panels.push(treePanel);
                // }
            } else if (f.tree) { //one tree named tree
                // console.log("ch 2");
                // treePanel = new pandemix.TreePanel;
                // treePanel.placePanel(row);
                // treePanel.initializePanelData(f.tree);
                // pandemix.panels.push(treePanel);
            } else { //one tree without a name, the whole file is a tree
                // console.log("ch 3");
                

                (function() {
                    var treePanel = new pandemix.TreePanel;
                treePanel.placePanel(row);
                treePanel.initializePanelData(f);
                pandemix.panels.push(treePanel);
                    pandemix.when(function() {return treePanel.finishedLoading; },
                           function() {
                               mapPanel.addLayer(pandemix.map.virusParticleLayer,
                               {name: treePanel.treeData.name, tree: treePanel.treeData.root, color: treePanel.panelID}
                               )
                           },
                           100);
                })();

            }
            
        }

	})();
</script>

</body></html>



















