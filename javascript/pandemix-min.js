pandemix=(function(){var f={};f.counter=0;f.focusedPanel=0;f.scale=1;f.panels=[];f.selectedLeaves=[];f.selectedNodes=[];f.globalData={};f.map={};d3.selection.prototype.size=function(){var g=0;this.each(function(){g+=1});return g};f.addGlobalZoomButton=function(g){var h=d3.select(g).attr("class","zoomControl");h.append("div").attr("class","zoom increase").on("click",function(){e(1)});h.append("div").attr("class","zoom decrease").on("click",function(){e(-1)})};f.addSearchBox=function(g){d3.select(g).attr("class","searchBox").append("input").attr("type","text").attr("id","searchInput").attr("value","search").on("keyup",d)};f.addColorPicker=function(g){d3.select(g).attr("class","colorBox").append("input").attr("type","text").attr("id","colorInput").attr("value","color").on("keyup",a)};function d(g){var g=g||d3.select("input#searchInput").node().value;var h=new RegExp(g);var j=[];if(g){d3.selectAll("svg.treePanel").selectAll(".leaf").each(function(l){if(h.test(l.name)){j.push(l)}})}f.selectedLeaves=j;f.callUpdate("leafSelectionUpdate")}function b(g){var g=g||document.getElementById("trait").value;var h=new RegExp(g);var j=[];if(g){d3.selectAll("svg.treePanel").selectAll(".node").each(function(l){for(var m in l){if(l.hasOwnProperty(m)){if(h.test(l[m])){j.push(l)}}}})}f.selectedLeaves=j;f.callUpdate("leafSelectionUpdate")}function a(){var g=d3.select("input#colorInput").node().value;if(g===""){g=null}f.callUpdate("leafColorUpdate",g)}function e(g){var h=f.scale+0.5*g;if(h<1){h=1}f.scale=h;f.callUpdate("zoomUpdate")}f.initializeCrossfilter=function(){f.nodes=crossfilter();f.nodeDateDim=f.nodes.dimension(function(g){return g.date});f.links=crossfilter();f.linkStartDateDim=f.links.dimension(function(g){return g.startDate});f.linkEndDateDim=f.links.dimension(function(g){return g.endDate});f.treeIdDim=f.links.dimension(function(g){return g.treeID});f.taxa=crossfilter();f.nameDim=f.taxa.dimension(function(g){return g.name});f.locDim=f.taxa.dimension(function(g){return g.location});f.dateDim=f.taxa.dimension(function(g){return g.date})};f.getNodeKey=function(h,g){return(h.name||g)};f.getLinkKey=function(h,g){return(h.target.name||g)};f.contains=function(g,j){var h;for(h=0;h<g.length;h+=1){if(g[h]===j){return true}}return false};f.accContains=function(g,j,l,m){var h;for(h=0;h<g.length;h+=1){if(l(g[h])===m(j)){return true}}return false};f.indexOf=function(g,j,l,m){var h;for(h=0;h<g.length;h+=1){if(l(g[h])===m(j)){return h}}return -1};f.containsLeaf=function(g,j){if(g.length===0){return false}var h;for(h=0;h<g.length;h+=1){if(g[h].name===j.name){return true}}return false};f.callUpdate=function(g){var h;for(h=0;h<f.panels.length;h+=1){if(f.panels[h].hasOwnProperty(g)){f.panels[h][g](arguments)}}};f.panelsLoaded=function(g){var h=true,j;for(j=0;j<f.panels.length;j+=1){if(f.panels[j].panelType===g&&f.panels[j].hasOwnProperty("finishedLoading")){h=h&&f.panels[j].finishedLoading()}}return h};f.when=function(l,j,g){var g=g||100;window.setTimeout(function h(){if(l()){j()}else{window.setTimeout(h,g)}},g)};f.getHSBColor=function(p,o,j,l,n){if(!(p&&o)&&p!==0){throw new Error("Called for HSB color without specifying color index or total colors.")}var g=j||0;var h=l||75;var q=n||50;var r=p%o;var m=(g+r*360/o)%360;return"hsl("+m+","+h+"%,"+q+"%)"};return f}());(function(){pandemix.TreePanel=function(){var I,d=undefined,F,V,m,E=true,j,q,N,K,O,h,S,v,Q,A,z,X,y,b,J,n,l,s,M,a,f,g;function o(Z,Y){var ab,aa;for(ab=0;ab<Z.length;ab+=1){for(aa=0;aa<Y[0].length;aa+=1){if(Z[ab]===Y[0][aa].__data__.target){Z[ab].uplink=d3.select(Y[0][aa]);break}}}}function x(Z){var Y=[],aa;for(aa=0;aa<Z.length;aa+=1){if(Z[aa].uplink){Y.push(Z[aa].uplink)}}return Y}function W(Z){var Y=true,aa;while(Y){Y=false;for(aa=0;aa<Z.length;aa+=1){if(Z[aa].parent.children[0]===Z[aa]){if(contains(Z,Z[aa].parent.children[1])&&!contains(Z,Z[aa].parent)){Z.push(Z[aa].parent);Y=true}}else{if(contains(Z,Z[aa].parent.children[0])&&!contains(Z,Z[aa].parent)){Z.push(Z[aa].parent);Y=true}}}}}function w(ab){var Z;var Y=ab.slice(0);var ac=Infinity;Y.forEach(function(ad){if(ad.depth<ac){ac=ad.depth}});for(Z=0;Z<Y.length;Z+=1){while(Y[Z].depth>ac){Y[Z]=Y[Z].parent}}var aa=false;while(!aa){aa=true;for(Z=1;Z<Y.length;Z+=1){if(Y[Z]!==Y[0]){for(Z=0;Z<Y.length;Z+=1){Y[Z]=Y[Z].parent}aa=false;break}}}return Y[0]}pandemix.nodeHeightToDate=function(Z,Y){return new Date((Y-1970-Z)*31557600000)};pandemix.dateToNodeHeight=function(Z,Y){return Y-1970-Z/31557600000};function G(Y){j.select(".aimLine").attr("x1",Y).attr("y1",N(f)).attr("x2",Y).attr("y2",0).style("stroke","red")}function R(Y){return"M"+q(Y.source.height)+","+N(Y.source.x)+"V"+N(Y.target.x)+"H"+q(Y.target.height)}function B(Y){return"M"+0+","+0+"h"+(q(Y.height)-q(A))}function t(Z,aa){var Y;for(Y=0;Y<aa.length;Y+=1){if(aa[Y].name===Z.name){aa.splice(Y,1);return}}console.log("removable element not found")}function D(aa,Z){var Y=function(ad,af){var ae;af(ad);if(ad.children){for(ae=0;ae<ad.children.length;ae+=1){Y(ad.children[ae],af)}}};Y(aa[0],function(af){af.rootDist=(af.parent?af.parent.rootDist:0)+(af.length);var ad=af.height;var ae=af.parent?af.parent.height:0;var ag=ad-ae;if(ag>0){console.log(I+" "+ag)}});console.log(I+" height span "+(Q-A));var ac=aa.map(function(ad){return ad.rootDist});console.log(I+" length span "+d3.max(ac));var ab=d3.scale.linear().domain([0,d3.max(ac)]).range([0,Z]);return ab}function P(){return navigator.appVersion.indexOf("Mac")!=-1}function p(){if(pandemix.focusedPanel!=I){pandemix.selectedNodes=[];pandemix.callUpdate("nodeSelectionUpdate");pandemix.selectedLeaves=[];pandemix.callUpdate("leafSelectionUpdate");U()}pandemix.focusedPanel=I;l=[d3.mouse(this),[]];d3.select(this.parentNode).append("rect").attr("id","extent").attr("x",l[0][0]).attr("y",l[0][1]).attr("width",0).attr("height",0);if(pandemix.brushHighlight){pandemix.selectedLeaves=[];pandemix.selectedPeriod=[0,0];d3.select(".axis").call(pandemix.globalTimeBrush.clear());pandemix.brushHighlight.remove();pandemix.brushHighlight=null;pandemix.callUpdate("leafSelectionUpdate");pandemix.callUpdate("timeSelectionUpdate")}event.preventDefault()}function u(){if(l){l[1]=d3.mouse(z[0][0]);if(l[1][0]>q(A)){l[1][0]=q(A)}if(l[1][1]>N(f)){l[1][1]=N(f)}d3.select("#extent").attr("x",d3.min([l[0][0],l[1][0]])).attr("y",d3.min([l[0][1],l[1][1]])).attr("width",Math.abs(l[1][0]-l[0][0])).attr("height",Math.abs(l[1][1]-l[0][1]))}}function C(){if(l){var Y,Z;d3.select("#extent").remove();if(l[1][0]<l[0][0]){Y=l[0][0];l[0][0]=l[1][0];l[1][0]=Y}if(l[1][1]<l[0][1]){Y=l[0][1];l[0][1]=l[1][1];l[1][1]=Y}Z=[];K.each(function(aa){if(l[1][0]>q(aa.source.height)){if(aa.target.x>aa.source.x){if(l[0][1]<N(aa.target.x)&&(l[1][1]>N(aa.target.x)&&l[0][0]<q(aa.target.height)||l[0][0]<q(aa.source.height)&&l[1][1]>N(aa.source.x))){Z.push(aa.target)}}else{if(l[1][1]>N(aa.target.x)&&(l[0][1]<N(aa.target.x)&&l[0][0]<q(aa.target.height)||l[0][0]<q(aa.source.height)&&l[0][1]<N(aa.source.x))){Z.push(aa.target)}}}});if(Z.length>1){U(w(Z))}else{if(Z.length===1){U(Z[0])}else{U()}}l=undefined;event.preventDefault()}}function U(Z){if(!Z){if(!d3.event.shiftKey){pandemix.selectedNodes=[];pandemix.callUpdate("nodeSelectionUpdate");pandemix.selectedLeaves=[];pandemix.callUpdate("leafSelectionUpdate")}}else{var ab=T(Z),aa,Y;if(!d3.event.shiftKey){pandemix.selectedLeaves=ab.slice(0)}else{for(Y=0;Y<ab.length;Y+=1){if(!pandemix.containsLeaf(pandemix.selectedLeaves,ab[Y])){pandemix.selectedLeaves.push(ab[Y])}}}pandemix.callUpdate("leafSelectionUpdate");aa=x(ab).concat(x(H(Z)));if(!d3.event.shiftKey){K.classed("highlighted",false)}if(Z.depth!==Infinity){for(Y=0;Y<aa.length;Y+=1){aa[Y].classed("highlighted",true)}}}}function H(aa){var Y=[];if(aa.children){Y.push(aa);for(var Z=0;Z<aa.children.length;Z++){Y=Y.concat(H(aa.children[Z]))}}return Y}function e(aa,Z){aa.parent=Z;if(aa.children){for(var Y=0;Y<aa.children.length;Y++){e(aa.children[Y],aa)}}}function T(aa){var Y=[];if(aa.children){for(var Z=0;Z<aa.children.length;Z++){Y=Y.concat(T(aa.children[Z]))}}else{Y.push(aa)}return Y}var r={panelType:"treePanel",finishedLoading:false,panelID:undefined,treeData:undefined,maxHeight:function(){return Q},minHeight:function(){return A},placePanel:function(Z,Y){I=0+pandemix.counter;this.panelID=I;pandemix.focusedPanel=I;var aa=d3.select(Z).classed("treePanel",true);if(aa.classed("collapsible")){m=aa.append("div").attr("class","panelControl");m.append("div").attr("class","panelControl collapseButton").on("click",function(){if(E){V.style("display","none")}else{V.style("display",null)}E=!E})}V=aa.append("div").attr("class","treePanel svgBox");j=V.append("svg").attr("class","treeTopology");a=parseInt(j.style("width").replace(/\D+/,""),10);f=parseInt(j.style("height").replace(/\D+/,""),10);g=parseInt(V.style("width").replace(/\D+/,""),10)-a-parseInt(j.style("padding-right").replace(/\D+/,""),10)-parseInt(j.style("padding-left").replace(/\D+/,""),10);j.style("width",a+g);J=j.append("line").attr("class","aimLine");pandemix.panels.push(r);pandemix.counter+=1},initializePanelData:function(Z,Y){var aa=this;d=Y||(function(){var ab=0;pandemix.panels.forEach(function(ac){if(ac.panelType==="treePanel"){ab+=1}});return pandemix.getHSBColor(ab,6,Math.floor(ab/6)*10)})();d3.json(Z,function(am){var af,ak,an,ae,ag,aj,ai,ad,ac=/(.+)\.fullSet/;aa.treeData=am;if(m){m.append("div").attr("class","panelControl name").text(am.name)}X=parseFloat(am.origin);F=d3.layout.cluster().size([f,a]).separation(function(){return 1});e(am.root,undefined);af=F.nodes(am.root);ak=F.links(af);ae=[];for(ag=0;ag<af.length;ag+=1){if(!af[ag].children){ae.push(af[ag].height)}}A=d3.min(ae);Q=am.root.height;ak.push();q=d3.scale.linear().domain([Q,A]).range([0,a]);N=d3.scale.linear().domain([0,f]).range([0,f]);K=j.selectAll("path.link").data(ak,pandemix.getLinkKey).enter().append("path").attr("class","link").attr("d",R);o(af,K);j.selectAll(".node").data(af,pandemix.getNodeKey).enter().append("g").attr("class",function(ao){if(ao.children){if(ao.depth===0){return"root inner node"}return"inner node"}return"leaf node"});O=j.selectAll(".inner").attr("transform",function(ao){return"translate("+q(ao.height)+","+N(ao.x)+")"});j.select(".root").append("path").attr("class","rootLink").attr("d",function(){return"M"+0+","+0+"h"+-20});h=j.selectAll(".leaf").attr("transform",function(ao){return"translate("+q(A)+","+N(ao.x)+")"});var al=f/h.size();h.append("text").attr("class","leafText").attr("dx",8).attr("text-anchor","start").text(function(ao){return ao.name});h.append("path").attr("class","dashedLink").attr("d",B);h.append("rect").attr("class","leafBack").attr("y",-al/2).attr("x",5).attr("width",g).attr("height",al).on("click",function(){pandemix.focusedPanel=I;var ar=d3.select(this.parentNode);K.classed("highlighted",false);if(d3.event.metaKey||d3.event.ctrlKey){S=ar;var at=!ar.classed("highlighted");ar.classed("highlighted",at);at?pandemix.selectedLeaves.push(ar.datum()):t(ar.datum(),pandemix.selectedLeaves);if(at){pandemix.callUpdate("focusUpdate",ar)}}else{if(d3.event.shiftKey){var aq=S?S.datum().x:0;var ap=ar.datum().x;if(aq>ap){var ao=ap;ap=aq;aq=ao}pandemix.selectedLeaves=[];h.each(function(au){if(aq<=au.x&&au.x<=ap){pandemix.selectedLeaves.push(au)}})}else{S=ar;pandemix.selectedLeaves=[ar.datum()];pandemix.callUpdate("focusUpdate",ar)}}pandemix.callUpdate("leafSelectionUpdate")});h.each(function(ao){if(!pandemix.globalData.hasOwnProperty(ao.name)){pandemix.globalData[ao.name]={height:ao.height};pandemix.taxa.add([{name:ao.name,date:pandemix.nodeHeightToDate(ao.height,X),location:ao.location||""}])}});for(ag=0;ag<pandemix.panels.length;ag+=1){if(pandemix.panels[ag].panelType==="legendPanel"){for(ad in am){if(am.hasOwnProperty(ad)){var ah=ac.exec(ad);if(ah){var ab={};ab[ah[1]]=am[ad].map(function(ao){return{name:ao,color:undefined}});pandemix.panels[ag].addTraits(ab)}}}pandemix.panels[ag].addTraits({Tree:[{name:am.name,color:d}]})}}for(ag=0;ag<pandemix.panels.length;ag+=1){if(pandemix.panels[ag].panelType==="traitSelectionPanel"){for(ad in am){if(am.hasOwnProperty(ad)){var ah=ac.exec(ad);if(ah){pandemix.panels[ag].addTraits([ah[1]])}}}pandemix.panels[ag].addTraits(["Tree"])}}z=j.append("rect").attr("width",a).attr("height",f).attr("class","brushBox").on("mousedown",p);d3.select(document).on("mousemove.treeSelect"+I,u).on("mouseup.treeSelect"+I,C);y=d3.time.scale().domain([pandemix.nodeHeightToDate(Q,X),pandemix.nodeHeightToDate(A,X)]).range([0,a]).clamp(true);ai=d3.svg.axis().scale(y).orient("bottom");s=false;b=j.append("g").attr("class","axis").attr("transform","translate(0,"+(f)+")").call(ai);pandemix.panels.forEach(function(ao){if(ao.panelType==="timePanel"){ao.updateGlobalTimeAxis(pandemix.nodeHeightToDate(Q,X),pandemix.nodeHeightToDate(A,X))}});pandemix.nodes.add(af.map(function(ao){return{node:ao,date:pandemix.nodeHeightToDate(ao.height,X),treeID:I,color:d}}));pandemix.links.add(ak.map(function(ao){return{link:ao,startDate:pandemix.nodeHeightToDate(ao.source.height,X),endDate:pandemix.nodeHeightToDate(ao.target.height,X),treeID:I,color:d}}));aa.finishedLoading=true})},leafSelectionUpdate:function(){v=h.filter(function(Y){return pandemix.containsLeaf(pandemix.selectedLeaves,Y)});h.classed("highlighted",false);v.classed("highlighted",true)},leafColorUpdate:function(Y){v.select("text").style("fill",Y[1])},timeSelectionUpdate:function(){if(n){n.attr("x",y(pandemix.selectedPeriod[0])).attr("width",y(pandemix.selectedPeriod[1])-y(pandemix.selectedPeriod[0]))}else{n=j.append("rect").attr("class","timeSelection").attr("x",y(pandemix.selectedPeriod[0])).attr("y",0).attr("height","100%").attr("width",y(pandemix.selectedPeriod[1])-y(pandemix.selectedPeriod[0]))}},nodeSelectionUpdate:function(){K.classed("highlighted",false);for(var Y=0;Y<pandemix.selectedNodes.length;Y+=1){pandemix.selectedNodes[Y].uplink.classed("highlighted",true)}},traitSelectionUpdate:function(){if(pandemix.traitType&&pandemix.traitValues){K.style("stroke",function(Z){for(var Y=0;Y<pandemix.traitValues.length;Y+=1){if(Z.target[pandemix.traitType]===pandemix.traitValues[Y].name){return pandemix.traitValues[Y].color}}return null})}},zoomUpdate:function(){N.range([0,f*pandemix.scale]);j.style("height",N(f));b.attr("transform","translate(0,"+N(f)+")");if(pandemix.selectedDate){G(y(pandemix.selectedDate))}z.attr("height",N(f));K.attr("d",R);O.attr("transform",function(Z){return"translate("+q(Z.height)+","+N(Z.x)+")"});h.attr("transform",function(Z){return"translate("+q(A)+","+N(Z.x)+")"});var Y=N(f)/h.size();j.selectAll(".leafBack").attr("y",-Y/2).attr("height",Y)},focusUpdate:function(Y){if(I!==pandemix.focusedPanel){var Z=h.filter(function(aa){return Y[1].datum().name===aa.name});if(!Z.empty()){V[0][0].scrollTop=N(Z.datum().x)-f/2}}},timeSlideUpdate:function(){G(y(pandemix.selectedDate))}};return r}})();(function(){pandemix.TraitSelectionPanel=function(){var f,o,e,g,l=0,j=0+pandemix.counter,m=["No trait"],h,d=1,b=2;pandemix.counter+=1;function n(){var p=g.selectAll(".traitRow").data(m,function(r){return r});var q=p.enter().append("g").attr("class","traitRow").on("click",function(r){g.selectAll(".traitRow").select(".traitRowBackground").classed("selected",false);d3.select(this).select(".traitRowBackground").classed("selected",true);pandemix.traitType=r;pandemix.callUpdate("traitTypeUpdate")});q.append("rect").attr("class","traitRowBackground").attr("y",-h).attr("height",h).attr("width","100%");q.select(".traitRowBackground").classed("selected",function(r){return r==="No trait"});q.append("text").attr("class","traitRowText").attr("dy",-1).text(function(r){return r});p.attr("transform",function(s,r){return"translate(0,"+((r+1)*(h+d))+")"});p.exit().remove()}var a={panelType:"traitSelectionPanel",placePanel:function(p){e=d3.select(p).classed("traitSelectionPanel",true);f=parseInt(e.style("width").replace(/\D+/,""),10);o=parseInt(e.style("height").replace(/\D+/,""),10);h=parseInt(e.style("font-size").replace(/\D+/,""),10);g=e.append("svg").attr("class","traitSvg").attr("width",f).attr("height",o);pandemix.panels.push(a)},addTraits:function(t){var r=false,q,s;for(q=0;q<t.length;q+=1){var p=false;for(s=0;s<m.length;s+=1){if(m[s]===t[q]){p=true;break}}if(!p){m.push(t[q]);r=true}}if(r){n()}}};return a}})();(function(){pandemix.LegendPanel=function(){var g,q,f,j,n=0,m=0+pandemix.counter,o={"No trait":[]},l,e=1,d=2,b=g,h=q;pandemix.counter+=1;function p(s){if(!s||!(s in o)){return}var u=function(){var x=o[s];var v=[];for(var w=0;w<x.length;w+=1){v.push({name:x[w].name,color:x[w].color||pandemix.getHSBColor(w,x.length),colorIsStatic:!!x[w].color,selected:true})}return v}();var r=j.selectAll(".traitRow").data(u,function(v){return v.name});var t=r.enter().append("g").attr("class","traitRow").on("click",function(v){if(!v.colorIsStatic){v.selected=!v.selected;pandemix.traitType=s;pandemix.traitValues=[];j.selectAll(".traitRow").each(function(w){if(w.selected){pandemix.traitValues.push(w)}});pandemix.callUpdate("traitSelectionUpdate");j.selectAll(".traitRow").select(".legendIcon").style("fill",function(w){if(w.selected){return w.color}return"gray"})}});t.append("rect").attr("class","traitRowBackground").attr("y",-l).attr("height",l).attr("width","100%").style("fill-opacity",0);t.append("rect").attr("class","legendIcon").attr("y",-l).attr("height",l).attr("width",l).style("fill",function(v){return v.color});t.append("text").attr("class","legendRowText").attr("x",(l+d)).text(function(v){return v.name});r.attr("transform",function(w,v){return"translate(0,"+((v+1)*(l+e))+")"});r.exit().remove();h=r.size()*(l+e);j.attr("height",d3.max([q,h]));if(h<q){f.style("overflow-y","hidden")}else{f.style("overflow-y",null)}r.select(".legendIcon").style("fill",function(v){if(v.selected){return v.color}return"gray"})}var a={panelType:"legendPanel",placePanel:function(r){f=d3.select(r).classed("legendPanel",true);g=parseInt(f.style("width").replace(/\D+/,""),10);q=parseInt(f.style("height").replace(/\D+/,""),10);l=parseInt(f.style("font-size").replace(/\D+/,""),10);j=f.append("svg").attr("class","legendSvg").attr("width",g).attr("height",q);pandemix.panels.push(a)},addTraits:function(v){var t=false,s;for(var r in v){if(v.hasOwnProperty(r)){if(o.hasOwnProperty(r)){for(s=0;s<v[r].length;s+=1){var u=pandemix.accContains(o[r],v[r][s],function(w){return w.name},function(w){return w.name});if(!u){o[r].push(v[r][s]);t=true}}}else{o[r]=v[r].slice(0);t=true}}}if(t){p("No trait")}},getTraits:function(){return o},traitTypeUpdate:function(){p(pandemix.traitType);pandemix.traitValues=[];j.selectAll(".traitRow").each(function(r){if(r.selected){pandemix.traitValues.push(r)}});pandemix.callUpdate("traitSelectionUpdate")}};return a}})();(function(){var m,h,g,f=[],p=[],j,n,b,d,e,o,a,l=0+pandemix.counter;pandemix.counter+=1;pandemix.TimePanel=function(){function x(){}function w(){var z=j.extent();pandemix.selectedPeriod=z;if(pandemix.brushHighlight){n.attr("x",h(z[0])).attr("width",h(z[1])-h(z[0]))}else{n=m.append("rect").attr("class","timeSelection").attr("x",h(z[0])).attr("y",0).attr("width",h(z[1])-h(z[0])).attr("height",a);pandemix.brushHighlight=n}pandemix.locDim.filter(null);pandemix.selectedLeaves=pandemix.dateDim.filterRange(z).top(Infinity);pandemix.callUpdate("timeSelectionUpdate");pandemix.callUpdate("leafSelectionUpdate")}function t(){if(j.empty()){if(n){n.remove();n=null;pandemix.brushHighlight=null}}}var u=false;var y=undefined;var q=undefined;function v(){event.preventDefault();u=true;if(n){n.remove();n=null;pandemix.brushHighlight=null;pandemix.selectedPeriod=[];pandemix.selectedLeaves=[];pandemix.callUpdate("timeSelectionUpdate");pandemix.callUpdate("leafSelectionUpdate")}var z=d3.mouse(y.node())[0];if(z>o-1){z=o-1}else{if(z<1){z=1}}q.style("left",(z-e/2)+"px");pandemix.selectedDate=h.invert(z);pandemix.callUpdate("timeSlideUpdate");d3.select("body").selectAll("span.date-calendar").text(pandemix.selectedDate.toDateString().substring(4))}function r(){if(u){var z=d3.mouse(y.node())[0];if(z>o-1){z=o-1}else{if(z<1){z=1}}q.style("left",(z-e/2)+"px");pandemix.selectedDate=h.invert(z);pandemix.callUpdate("timeSlideUpdate");d3.select("body").selectAll("span.date-calendar").text(pandemix.selectedDate.toDateString().substring(4))}}function s(){if(u){u=false}}b={panelType:"timePanel",updateGlobalTimeAxis:function(z,A){f.push(z);p.push(A);h.domain([d3.min(f),d3.max(p)]);m.call(g)},placePanel:function(z){d=d3.select(z).classed("timePanel",true);y=d.append("div").attr("class","sliderBackground").on("mousedown",v);d3.select(document).on("mousemove.time",r).on("mouseup.time",s);q=y.append("div").attr("class","timeSlider");e=parseInt(q.style("width").replace(/\D+/,""),10);m=d.append("svg").attr("class","timeLine");o=parseInt(m.style("width").replace(/\D+/,""),10);a=parseInt(m.style("height").replace(/\D+/,""),10);h=d3.time.scale().domain([0,1]).range([0,o]);g=d3.svg.axis().scale(h).orient("bottom");j=d3.svg.brush().x(h).on("brushstart",x).on("brush",w).on("brushend",t);pandemix.globalTimeBrush=j;m.call(j).call(g);pandemix.panels.push(b)}};return b}})();(function(){pandemix.MapPanel=function(){var g,d=[[-180,-90],[180,90]],f=[],a,h=undefined,e={};contoursLoaded=false,centroidsLoaded=false,previousSelectedDate=undefined,panelID=0+pandemix.counter,zCounter=1;pandemix.counter+=1;var b={panelType:"mapPanel",placePanel:function(l,m,o){var j=m||[0,0];var n=o||4;g=new L.Map(l,{center:j,zoom:n,maxBounds:[[-90,-180],[90,180]]});a=L.control.layers(null,null).addTo(g);pandemix.panels.push(b);return b},loadContours:function(j){var l=this;d3.json(j,function(m){var n=d3.geo.path().projection(l.project);h=m;contoursLoaded=true});return b},loadCentroids:function(j){var l=this;if(!j){pandemix.when(function(){return contoursLoaded},function(){var o=d3.geo.path().projection(l.project);for(var m=0;m<h.features.length;m++){var n=o.centroid(h.features[m]);if(n){n=g.layerPointToLatLng(new L.Point(n[0],n[1]));e[h.features[m].properties.name]=[n.lng,n.lat]}}centroidsLoaded=true},100)}else{d3.csv(j,function(m){m.forEach(function(n){e[n.location]=[n.longitude,n.latitude]});centroidsLoaded=true})}return b},addTileLayer:function(m){var j=new L.TileLayer(m,{noWrap:true,zIndex:zCounter});zCounter+=1;g.addLayer(j);a.addOverlay(j,"Tiles");return b},addLayer:function(n,m){var o=this;var m=m||{};m.zIndex=zCounter;zCounter+=1;var j=new n();a.addOverlay(j,m.name||"layer");pandemix.when(function(){if(j.needsContours){return contoursLoaded}else{if(j.needsCentroids){return centroidsLoaded}else{if(j.needsContours&&j.needsCentroids){return contoursLoaded&&centroidsLoaded}else{return true}}}},function(){m.map=g;m.project=o.project;m.bounds=d;m.mapData=h;m.centroids=e;j.initDraw(m);g.addLayer(j);f.push(j)},100);return b},getMap:function(){return g},leafSelectionUpdate:function(){var l=[],j;for(j=0;j<pandemix.selectedLeaves.length;j+=1){if(!pandemix.contains(l,pandemix.selectedLeaves[j].location)){l.push(pandemix.selectedLeaves[j].location)}}for(j=0;j<f.length;j+=1){if("leafSelectionUpdate" in f[j]){f[j].leafSelectionUpdate(l)}}},timeSelectionUpdate:function(){},timeSlideUpdate:function(){var j=pandemix.selectedDate;var n=undefined;var l=undefined;if(!previousSelectedDate){l=true}else{l=previousSelectedDate<j}previousSelectedDate=j;for(i=0;i<f.length;i+=1){if("timeSlideUpdate" in f[i]){if(!n){pandemix.linkStartDateDim.filter(function(o){return o<j});var m=pandemix.linkEndDateDim.filter(function(o){return o>j}).top(Infinity)}f[i].timeSlideUpdate(m,l)}}},traitSelectionUpdate:function(){for(var j=0;j<f.length;j+=1){if("traitSelectionUpdate" in f[j]){f[j].traitSelectionUpdate()}}},project:function(l){var j=g.latLngToLayerPoint([l[1],l[0]]);return[j.x,j.y]}};return b}})();(function(){pandemix.map.regionOutlineLayer=L.Class.extend({needsContours:true,svg:undefined,g:undefined,bounds:undefined,path:undefined,feature:undefined,project:undefined,initialize:function(){},initDraw:function(a){var b=this;b.map=a.map;b.project=a.project;b.bounds=a.bounds;b.el=L.DomUtil.create("div","provinceLayer leaflet-zoom-hide");d3.select(b.el).style("position","absolute").style("z-index",a.zIndex);b.svg=d3.select(b.el).append("svg");b.svg.on("mousedown",function(){event.preventDefault()});b.g=b.svg.append("g");d(a.mapData);function d(e){b.path=d3.geo.path().projection(b.project);b.feature=b.g.selectAll(".mapPath").data(e.features).enter().append("path").attr("class","mapPath").on("click",function(f){pandemix.dateDim.filter(null);pandemix.selectedLeaves=pandemix.locDim.filter(f.properties.name).top(Infinity);pandemix.callUpdate("leafSelectionUpdate");d3.select(this).classed("mapHighlighted",true)})}b.map.getPanes().overlayPane.appendChild(b.el);b.svg.style("display","none")},onAdd:function(){var a=this;a.svg.style("display",null);a.map.on("viewreset",a.reset,a);a.reset()},onRemove:function(){var a=this;a.svg.style("display","none");a.map.off("viewreset",a.reset,a)},reset:function(){var d=this;var a=d.project(d.bounds[0]),b=d.project(d.bounds[1]);d.svg.attr("width",Math.abs(b[0]-a[0])).attr("height",Math.abs(a[1]-b[1])).style("margin-left",a[0]+"px").style("margin-top",b[1]+"px");d.g.attr("transform","translate("+-a[0]+","+-b[1]+")");d.feature.attr("d",d.path)},leafSelectionUpdate:function(a){this.feature.classed("mapHighlighted",function(b){return pandemix.contains(a,b.properties.name)})}})})();(function(){pandemix.map.centroidLayer=L.Class.extend({needsCentroids:true,svg:undefined,g:undefined,bounds:undefined,circles:undefined,project:undefined,centroids:undefined,initialize:function(){},initDraw:function(a){var b=this;b.map=a.map;b.project=a.project;b.bounds=a.bounds;b.centroids=a.centroids;b.el=L.DomUtil.create("div","centroidLayer leaflet-zoom-hide");d3.select(b.el).style("position","absolute").style("z-index",a.zIndex);b.svg=d3.select(b.el).append("svg");b.svg.on("mousedown",function(){event.preventDefault()});b.g=b.svg.append("g");var d=[];for(c in b.centroids){if(b.centroids.hasOwnProperty(c)){d.push({name:c,center:[b.centroids[c][0],b.centroids[c][1]]})}}b.circles=b.g.selectAll("circle").data(d).enter().append("circle");b.map.getPanes().overlayPane.appendChild(b.el);b.svg.style("display","none")},onAdd:function(b){var a=this;a.svg.style("display",null);b.on("viewreset",a.reset,a);a.reset()},onRemove:function(b){var a=this;a.svg.style("display","none");b.off("viewreset",a.reset,a)},reset:function(){var e=this;var b=e.project(e.bounds[0]),d=e.project(e.bounds[1]);e.svg.attr("width",Math.abs(d[0]-b[0])).attr("height",Math.abs(b[1]-d[1])).style("margin-left",b[0]+"px").style("margin-top",d[1]+"px");var a=1*e.map.getZoom();e.g.attr("transform","translate("+-b[0]+","+-d[1]+")");e.circles.attr("cx",function(f){return e.project(f.center)[0]}).attr("cy",function(f){return e.project(f.center)[1]}).attr("r",a)},traitSelectionUpdate:function(){var a=this;if(pandemix.traitValues){a.circles.style("fill",function(e){for(var b=0;b<pandemix.traitValues.length;b+=1){if(e.name===pandemix.traitValues[b].name){return pandemix.traitValues[b].color}}return null})}}})})();(function(){var d=true;var b=true;var a=function(l){var e,h=true,f,g;if(l.nodes.length<1){if(l.tree.children){h=false}for(e=0;e<l.foci.length;e+=1){if(l.foci[e].name===l.tree.location){f=l.project(l.centroids[l.tree.location]);l.nodes.push({virNum:l.virNum,id:e,x:f[0],y:f[1],r:l.radius,children:l.tree.children});l.virNum+=1;break}}}else{h=true;g=[];l.nodes.forEach(function(m){if(m.children){h=false;m.children.forEach(function(n){for(e=0;e<l.foci.length;e+=1){if(l.foci[e].name===n.location){g.push({virNum:l.virNum,id:e,x:m.x,y:m.y,r:l.radius,children:n.children});l.virNum+=1;break}}})}});l.nodes=g;l.force.nodes(g)}console.log(l.nodes.length);l.force.start();var j=l.g.selectAll("circle.virusParticle").data(l.nodes,function(m){return m.virNum});j.exit().transition().attr("r",0).remove();j.enter().append("svg:circle").attr("class","virusParticle").attr("cx",function(m){return m.x}).attr("cy",function(m){return m.y}).style("fill",l.fill(l.color)).style("stroke",1).attr("r",0).transition().attr("r",function(m){return m.r});if(h){clearInterval(l.intervalID)}};pandemix.map.virusParticleLayer=L.Class.extend({needsCentroids:true,svg:undefined,g:undefined,bounds:undefined,tree:undefined,force:undefined,nodes:undefined,foci:undefined,centroids:undefined,currNodes:undefined,project:undefined,fill:d3.scale.category10(),color:undefined,radius:undefined,virNum:0,intervalID:undefined,initialize:function(){},initDraw:function(g){var h=this;h.map=g.map;h.tree=g.tree;h.project=g.project;h.centroids=g.centroids;h.currNodes=[h.tree];h.color=g.color;h.foci=[];h.bounds=g.bounds;h.el=L.DomUtil.create("div","virusParticleLayer leaflet-zoom-hide");d3.select(h.el).style("position","absolute").style("z-index",g.zIndex);h.svg=d3.select(h.el).append("svg");h.svg.on("mousedown",function(){event.preventDefault()});h.g=h.svg.append("g");var e=h.reset();h.nodes=[];h.force=d3.layout.force().nodes(h.nodes).links([]).gravity(0).size(e).charge(-0.5).friction(0.85);h.force.on("tick",function(o){var n=0.1*o.alpha;h.nodes.forEach(function(q,p){q.y+=(h.foci[q.id].y-q.y)*n;q.x+=(h.foci[q.id].x-q.x)*n});h.g.selectAll("circle.virusParticle").attr("cx",function(p){return p.x}).attr("cy",function(p){return p.y})});var f=(31557600000/365.25);var l=[new Date(30*31557600000),new Date(30*31557600000+f*10)];var m;var j=[];h.map.getPanes().overlayPane.appendChild(h.el);h.svg.style("display","none")},timeSelectionUpdate:function(l){var j=this;var m=[];l.forEach(function(n){if(n.treeID===j.color){m.push(n.node)}});var e,f,g;g=[];m.forEach(function(r){var p=r.parent;var q=false;var o=[];for(e=0;e<j.nodes.length;e+=1){var s=j.nodes[e];if(s.node===p){q=true;o.push(s.x);o.push(s.y);if(d){j.nodes.splice(e,1)}break}}if(r.children){r.children.forEach(function(n){for(e=0;e<j.foci.length;e+=1){if(j.foci[e].name===n.location){if(!q){o=j.project(j.centroids[n.location])}j.nodes.push({virNum:j.virNum,id:e,x:o[0],y:o[1],r:j.radius,node:n});j.virNum+=1;break}}})}else{if(b){for(e=0;e<j.nodes.length;e+=1){var s=j.nodes[e];if(s.node===r){j.nodes.splice(e,1);break}}}}});j.force.start();var h=j.g.selectAll("circle.virusParticle").data(j.nodes,function(n){return n.virNum});h.exit().remove();h.enter().append("svg:circle").attr("class","virusParticle").attr("cx",function(n){return n.x}).attr("cy",function(n){return n.y}).style("fill",j.fill(j.color)).style("stroke",1).attr("r",function(n){return n.r})},timeSlideUpdate:function(m,g){var j=this;var l=undefined;var n=[];var e;m.forEach(function(o){if(o.treeID===j.color){n.push(o.link);l=o.color}});var f=[];n.forEach(function(o){var q=false;var p=undefined;var r=undefined;for(e=0;e<j.nodes.length;e+=1){if(j.nodes[e].node===o.target){q=true;f.push(j.nodes[e]);break}if(g&&j.nodes[e].node===o.source){p=[j.nodes[e].x,j.nodes[e].y];r=e}}if(!q){for(e=0;e<j.foci.length;e+=1){if(j.foci[e].name===o.target.location){if(g&&!p){p=j.project(j.centroids[o.source.location])}else{if(!g){p=j.project(j.centroids[o.target.location])}}f.push({virNum:j.virNum,id:e,x:p[0],y:p[1],r:j.radius,node:o.target,color:l});j.virNum+=1;break}}}});j.nodes=f;j.force.nodes(f);j.force.start();var h=j.g.selectAll("circle.virusParticle").data(j.nodes,function(o){return o.virNum});h.exit().remove();h.enter().append("svg:circle").attr("class","virusParticle").attr("cx",function(o){return o.x}).attr("cy",function(o){return o.y}).style("fill",function(o){return o.color}).style("stroke",1).attr("r",function(o){return o.r})},onAdd:function(f){var e=this;e.svg.style("display",null);f.on("viewreset",e.reset,e);e.reset()},onRemove:function(f){var e=this;e.svg.style("display","none");f.off("viewreset",e.reset,e)},reset:function(){var l=this,e,j;var f=l.project(l.bounds[0]),g=l.project(l.bounds[1]);e=g[0]-f[0];j=f[1]-g[1];l.svg.attr("width",e).attr("height",j).style("margin-left",f[0]+"px").style("margin-top",g[1]+"px");l.g.attr("transform","translate("+-f[0]+","+-g[1]+")");l.radius=l.map.getZoom();l.g.selectAll("circle.virusParticle").attr("r",l.radius);l.foci=[];for(c in l.centroids){if(l.centroids.hasOwnProperty(c)){l.foci.push({name:c,x:l.project(l.centroids[c])[0],y:l.project(l.centroids[c])[1],occupants:[],size:0})}}if(l.force){l.force.charge(-l.radius/8).start()}return[e,j]}})})();(function(){pandemix.map.bubbleChartLayer=L.Class.extend({needsCentroids:true,svg:undefined,g:undefined,bounds:undefined,tree:undefined,force:undefined,nodes:undefined,foci:undefined,centroids:undefined,project:undefined,color:undefined,sizeModifier:undefined,virNum:0,intervalID:undefined,initialize:function(){},initDraw:function(a){var b=this;b.map=a.map;b.tree=a.tree;b.project=a.project;b.centroids=a.centroids;b.color=a.color;b.foci=[];b.bounds=a.bounds;b.prevData={};b.el=L.DomUtil.create("div","bubbleChartLayer leaflet-zoom-hide");d3.select(b.el).style("position","absolute").style("z-index",a.zIndex);b.svg=d3.select(b.el).append("svg");b.svg.on("mousedown",function(){event.preventDefault()});b.g=b.svg.append("g");b.nodes=[];b.force=d3.layout.force().nodes(b.nodes).links([]).gravity(0).charge(function(e){return -1*Math.floor(Math.sqrt(e.size*b.sizeModifier))});b.force.on("tick",function(f){var d=0.1*f.alpha;b.nodes.forEach(function(g,e){g.y+=(b.foci[g.id].y-g.y)*d;g.x+=(b.foci[g.id].x-g.x)*d});b.g.selectAll("circle.bubble").attr("cx",function(e){return e.x}).attr("cy",function(e){return e.y})});b.map.getPanes().overlayPane.appendChild(b.el);b.svg.style("display","none")},timeSlideUpdate:function(h){var f=this;var b;var d=[];var g={};h.forEach(function(n){var a=n.link;var m=[a.target.location,n.treeID];if(g.hasOwnProperty(m)){g[m].size+=1}else{for(b=0;b<f.foci.length;b+=1){if(f.foci[b].name===a.target.location){var j=[];var o=0;if(f.prevData.hasOwnProperty(m)){j[0]=f.prevData[m].x;j[1]=f.prevData[m].y;o=f.prevData[m].size}else{j=f.project(f.centroids[a.target.location])}g[m]={key:m,id:b,x:j[0],y:j[1],size:1,prevSize:o,color:n.color};break}}}});f.prevData=g;for(k in g){if(g.hasOwnProperty(k)){d.push(g[k])}}f.nodes=d;f.force.nodes(d);f.force.start();var e=f.g.selectAll("circle.bubble").data(f.nodes,function(a){return a.key});e.exit().transition().attr("r",0).remove();e.enter().append("svg:circle").attr("class","bubble").attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y}).style("fill",function(a){return a.color}).attr("r",0);e.transition().delay(function(a){return a.prevSize>a.size?0:250}).attr("r",function(a){return Math.sqrt(f.sizeModifier*a.size)})},onAdd:function(b){var a=this;a.svg.style("display",null);b.on("viewreset",a.reset,a);a.reset()},onRemove:function(b){var a=this;a.svg.style("display","none");b.off("viewreset",a.reset,a)},reset:function(){var g=this,b,f;if(g.force){g.force.stop()}var d=g.project(g.bounds[0]),e=g.project(g.bounds[1]);b=e[0]-d[0];f=d[1]-e[1];g.svg.attr("width",b).attr("height",f).style("margin-left",d[0]+"px").style("margin-top",e[1]+"px");g.g.attr("transform","translate("+-d[0]+","+-e[1]+")");var j=g.foci.slice(0);g.foci=[];for(c in g.centroids){if(g.centroids.hasOwnProperty(c)){g.foci.push({name:c,x:g.project(g.centroids[c])[0],y:g.project(g.centroids[c])[1]})}}if(g.nodes){g.nodes.forEach(function(h){h.x+=g.foci[h.id].x-j[h.id].x;h.y+=g.foci[h.id].y-j[h.id].y})}g.sizeModifier=g.map.getZoom()*g.map.getZoom();var a=g.g.selectAll("circle.bubble").attr("cx",function(h){return h.x}).attr("cy",function(h){return h.y}).attr("r",function(h){return Math.sqrt(g.sizeModifier*h.size)});if(pandemix.selectedDate){pandemix.callUpdate("timeSlideUpdate")}return[b,f]}})})();(function(){pandemix.map.bubbleTransLayer=L.Class.extend({needsCentroids:true,svg:undefined,g:undefined,bounds:undefined,tree:undefined,force:undefined,nodes:undefined,foci:undefined,centroids:undefined,currNodes:undefined,project:undefined,color:undefined,radius:undefined,virNum:0,intervalID:undefined,initialize:function(){},initDraw:function(a){var b=this;b.map=a.map;b.tree=a.tree;b.project=a.project;b.centroids=a.centroids;b.currNodes=[b.tree];b.color=a.color;b.foci=[];b.bounds=a.bounds;b.el=L.DomUtil.create("div","bubbleTransLayer leaflet-zoom-hide");d3.select(b.el).style("position","absolute").style("z-index",a.zIndex);b.svg=d3.select(b.el).append("svg");b.svg.on("mousedown",function(){event.preventDefault()});b.g=b.svg.append("g");b.nodes=[];b.map.getPanes().overlayPane.appendChild(b.el);b.svg.style("display","none")},timeSlideUpdate:function(h,e){var g=this;var b;var d=[];var j=[];h.forEach(function(o){var a=o.link;j.push(a.target);var n=false;for(b=0;b<g.nodes.length;b+=1){if(g.nodes[b]===a.target){n=true;break}}if(!n){var m,p;if(e){if(a.source.location!==a.target.location){p=g.project(g.centroids[a.target.location]);m=g.project(g.centroids[a.source.location]);d.push({targX:p[0],targY:p[1],initX:m[0],initY:m[1],r:g.radius,treeID:o.treeID,color:o.color})}}else{if(a.target.children){a.target.children.forEach(function(l){if(l.location!==a.target.location){m=g.project(g.centroids[l.location]);p=g.project(g.centroids[a.target.location]);d.push({targX:p[0],targY:p[1],initX:m[0],initY:m[1],r:g.radius,treeID:o.treeID,color:o.color})}})}}}});g.nodes=j;var f=g.g.selectAll("circle.bubbleTrans").data(d);f.enter().append("svg:circle").attr("class","bubbleTrans").attr("cx",function(a){return a.initX}).attr("cy",function(a){return a.initY}).style("fill",function(a){return a.color}).style("stroke",1).attr("r",function(a){return a.r}).transition().ease("linear").duration(500).attr("cx",function(a){return a.targX}).attr("cy",function(a){return a.targY}).remove()},onAdd:function(b){var a=this;a.svg.style("display",null);b.on("viewreset",a.reset,a);a.reset()},onRemove:function(b){var a=this;a.svg.style("display","none");b.off("viewreset",a.reset,a)},reset:function(){var f=this,a,e;var b=f.project(f.bounds[0]),d=f.project(f.bounds[1]);a=d[0]-b[0];e=b[1]-d[1];f.svg.attr("width",a).attr("height",e).style("margin-left",b[0]+"px").style("margin-top",d[1]+"px");f.g.attr("transform","translate("+-b[0]+","+-d[1]+")");f.radius=f.map.getZoom()-1;f.g.selectAll("circle.bubbleTrans").attr("r",f.radius);f.foci=[];for(c in f.centroids){if(f.centroids.hasOwnProperty(c)){f.foci.push({name:c,x:f.project(f.centroids[c])[0],y:f.project(f.centroids[c])[1],occupants:[],size:0})}}if(f.force){f.force.charge(-f.radius/8).start()}return[a,e]}})})();